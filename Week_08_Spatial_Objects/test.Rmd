---
title: "Tutorial: Working with Spatial Objects in R - SOLUTION"
subtitle: "A Hands-On Guide to sf and terra Packages"
author: "prepared by: Alejandro Ordonez"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    highlight: tango
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Introduction

Welcome to this tutorial on working with spatial objects in R! In this exercise, you'll learn how to:

- Load and visualize spatial data
- Work with `sf` (simple features) objects
- Transform coordinate reference systems (CRS)
- Create and manipulate spatial points and polygons
- Extract values from raster data
- Combine different spatial datasets

We'll use the fascinating case study of Bigfoot sightings across North America to explore these spatial analysis techniques!

---

# Part 1: Loading Required Packages

First, let's load the necessary packages for spatial analysis.

```{r load-packages}
# Load required packages for spatial analysis
library(sf)  # For vector spatial data (simple features)
library(terra)  # For raster spatial data
library(rnaturalearth)  # For accessing Natural Earth map data
library(rnaturalearthdata)
library(tidyverse)  # For data manipulation and visualization
```

**SOLUTION:** The packages are: `sf`, `terra`, `rnaturalearth`, and `tidyverse`

---

# Part 2: Loading and Exploring Point Data

## 2.1 Loading Data from an Online Source

Let's load Bigfoot sighting data from an online repository.

```{r load-data}
# URL for Bigfoot sightings data
Bigfoot.URL <- "https://opendata.arcgis.com/datasets/9947fc49e6c44120b4a1b3133c073dbc_0.csv"

# Load the CSV file
Bigfoot.dta <- read.csv(Bigfoot.URL)

# View the first few rows
head(Bigfoot.dta)
```

**SOLUTION:** `read.csv()` reads CSV files and `head()` displays the first 6 rows.

## 2.2 Creating Your First Spatial Plot

Let's visualize the Bigfoot sightings as a simple scatter plot.

```{r first-plot}
# Create a scatter plot of the sighting locations
plot(Bigfoot.dta[, c("Lon", "Lat")],  # Select longitude and latitude columns
     pch = 19,     # Use filled circles (19)
     col = "red")   # Use red color
```

**SOLUTION:** `plot()` is the plotting function, `"Lon"` and `"Lat"` are the coordinate columns, `19` is the code for filled circles, and `"red"` is the color.

---

# Part 3: Working with Polygon Data

## 3.1 Loading World Map Data

Now let's add geographical context by loading a world map.

```{r load-world-map}
# Get world map from Natural Earth at medium scale
wrld_simpl <- rnaturalearth::ne_countries(type = "countries", 
                                           scale = "medium")

# Check the class of the object
class(wrld_simpl)

# Plot the world map
plot(wrld_simpl)

# Check the structure
summary(wrld_simpl)
```

**SOLUTION:** `ne_countries()` gets country data with arguments `type` and `scale`. `class()` checks object class, `plot()` displays it, and `summary()` shows structure.

## 3.2 Subsetting Spatial Data

Let's extract only North American countries from the world map.

```{r subset-north-america}
# Filter for Canada, USA, and Mexico
NoAmPoly <- wrld_simpl %>%
  filter(name_en %in% c("Canada", "United States of America", "Mexico"))

# Check the country names
NoAmPoly$name_en

# Plot only the geometry (outlines)
plot(st_geometry(NoAmPoly))
```

**SOLUTION:** `filter()` is the dplyr filtering function, `name_en` is the column with country names, and `st_geometry()` extracts just the spatial geometry from sf objects.

## 3.3 Overlaying Points on Polygons

Now let's combine our point data with the polygon map.

```{r overlay-plot}
# First, plot the Bigfoot sightings
plot(Bigfoot.dta[, c("Lon", "Lat")],
     pch = 19,
     col = "red")

# Add the North America polygon on top
plot(st_geometry(NoAmPoly),
     add = TRUE,      # Add to existing plot
     col = NA)       # No fill color (NA)
```

**SOLUTION:** `st_geometry()` extracts geometry, `add` argument set to `TRUE` adds to existing plot, and `NA` means no fill color.

---

# Part 4: Coordinate Reference Systems (CRS)

## 4.1 Understanding and Transforming Projections

Maps can be distorted depending on their projection. Let's reproject our data to Albers Equal Area for North America.

```{r transform-crs}
# Define the Albers Equal Area projection for North America
AEA.proj <- "+proj=aea +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs"

# Transform the world map to Albers projection
wrld_simpl.AEA <- st_transform(x = wrld_simpl, 
                               crs = AEA.proj)

# Transform North America polygon
NoAmPoly.AEA <- st_transform(NoAmPoly, AEA.proj)

# Check the new CRS
st_crs(NoAmPoly.AEA)
```

**SOLUTION:** `st_transform()` transforms CRS with arguments `x` (the object) and `crs` (target projection). `st_crs()` checks the coordinate reference system.

## 4.2 Plotting with the New Projection

```{r plot-transformed}
# Plot the transformed North America
plot(st_geometry(NoAmPoly.AEA),
     col = "lightgrey")
```

---

# Part 5: Converting Data Frames to Spatial Objects

## 5.1 Creating sf Point Objects

Let's convert our Bigfoot data frame into a proper spatial object.

```{r create-sf-points}
# Convert data frame to sf POINT object
Bigfoot.SpaPnt <- st_as_sf(Bigfoot.dta,
                            coords = c("Lon", "Lat"),  # Column names for coordinates
                            crs = 4326)                 # WGS84 CRS code

# Check the class
class(Bigfoot.SpaPnt)

# Check the CRS
st_crs(Bigfoot.SpaPnt)
```

**SOLUTION:** `st_as_sf()` creates sf objects from data frames, `coords` specifies coordinate columns with `"Lon"` and `"Lat"`, `crs` sets the coordinate system. `class()` and `st_crs()` check object properties.

## 5.2 Transforming Point Data

Now transform the points to match our Albers projection.

```{r transform-points}
# Transform Bigfoot sightings to Albers Equal Area
Bigfoot.SpaPnt.AEA <- st_transform(x = Bigfoot.SpaPnt,
                                   crs = AEA.proj)

# Plot North America polygon
plot(st_geometry(NoAmPoly.AEA), col = "lightgrey")

# Add transformed Bigfoot points
plot(st_geometry(Bigfoot.SpaPnt.AEA),
     add = TRUE,
     pch = 19,
     col = "red",
     cex = 0.5)
```

**SOLUTION:** `st_transform()` with arguments `x` and `crs`, `st_geometry()` extracts geometry, and `add = TRUE` adds to existing plot.

---

# Part 6: Working with Raster Data

## 6.1 Loading Raster Data

Let's load climate data (WorldClim bioclimatic variables) to understand Bigfoot's environmental preferences.

```{r load-raster}
# Load WorldClim bioclimatic variables
WC.Bioclim <- rast(x = "wc2.1_10m_bio_1.tif")

# Check the raster properties
print(WC.Bioclim)

# Check the CRS
crs(WC.Bioclim)

# Get the number of layers
nlyr(WC.Bioclim)
```

**SOLUTION:** `rast()` reads raster data, `print()` displays info, `crs()` checks CRS, and `nlyr()` counts layers.

## 6.2 Cropping and Masking Raster Data

Let's crop the global climate data to just North America.

```{r crop-raster}
# First, transform North America polygon to match raster CRS
NoAmPoly.WGS84 <- st_transform(NoAmPoly, crs = 4326)

# Crop raster to North America extent
NoAm.WC.Bioclim <- crop(x = WC.Bioclim,
                        y = NoAmPoly.WGS84)

# Mask to North America shape
NoAm.WC.Bioclim <- mask(x = NoAm.WC.Bioclim,
                        mask = NoAmPoly.WGS84)

# Plot the first layer (Annual Mean Temperature)
plot(NoAm.WC.Bioclim[[1]])  # Select layer 1
```

**SOLUTION:** `4326` is the EPSG code for WGS84, `crop()` crops rasters with arguments `x` and `y`, `mask()` masks rasters with arguments `x` and `mask`, and `1` selects the first layer.

## 6.3 Transforming Raster Projections

Now let's reproject our raster to Albers Equal Area.

```{r transform-raster}
# Transform raster to Albers projection
#NoAm.WC.Bioclim.AEA <- project(x = NoAm.WC.Bioclim,
#                               y = AEA.proj,
#                               filename="wc2.1_10m_bio_1_Proj.tif",
#                               overwrite=TRUE)
NoAm.WC.Bioclim.AEA <- rast("wc2.1_10m_bio_1_Proj.tif")
# Plot the transformed raster
plot(NoAm.WC.Bioclim.AEA[[1]])
plot(st_geometry(NoAmPoly.AEA), add = TRUE)
```

**SOLUTION:** `project()` transforms (reprojects) rasters with arguments `x` (raster) and `y` (target CRS). `st_geometry()` extracts polygon geometry.

---

# Part 7: Extracting Raster Values at Point Locations

## 7.1 Extract Climate Data for Bigfoot Sightings

Let's find out what climate conditions Bigfoot prefers!

```{r extract-values}
# Extract bioclimatic values at Bigfoot sighting locations
BFC <- terra::extract(x = WC.Bioclim,
                      y = Bigfoot.SpaPnt)

# View the first few rows
head(BFC)

# Check dimensions
dim(BFC)
```

**SOLUTION:** `extract()` extracts raster values at points with arguments `x` (raster) and `y` (points). `head()` views data and `dim()` checks dimensions.

## 7.2 Identifying Missing Data

Check if any sightings are missing environmental data.

```{r check-na}
# Find rows with NA values using apply
apply(X = BFC,
      MARGIN = 2,  # Apply to columns
      FUN = function(x) { which(is.na(x)) })

# Alternative using dplyr
rows_with_na <- as_tibble(BFC) %>%
  mutate(row_number = row_number()) %>%
  filter(if_any(everything(), is.na)) %>%
  select(row_number)

print(rows_with_na)
```

**SOLUTION:** `apply()` applies functions across margins with arguments `X` (data), `MARGIN` (1=rows, 2=columns), and `FUN` (function). `row_number()` creates row numbers and `if_any()` filters rows with any NA.

## 7.3 Visualizing Points with Missing Data

```{r plot-missing}
# Plot North America
plot(st_geometry(NoAmPoly.AEA), 
     col = "lightgrey",
     xlim = range(st_coordinates(Bigfoot.SpaPnt.AEA)[, 1]),
     ylim = range(st_coordinates(Bigfoot.SpaPnt.AEA)[, 2]))

# Add all Bigfoot sightings in red
plot(st_geometry(Bigfoot.SpaPnt.AEA),
     add = TRUE,
     pch = 19,
     col = "red",
     cex = 0.5)

# Highlight points with missing data in black
plot(st_geometry(Bigfoot.SpaPnt.AEA[c(3595, 3682), ]),
     add = TRUE,
     pch = 19,
     col = "black",
     cex = 1.5)
```

**SOLUTION:** `st_coordinates()` extracts coordinates from sf objects, `Bigfoot.SpaPnt.AEA` is the transformed points object, and `3595` and `3682` are the row numbers with missing data.

---

# Part 8: Advanced Visualization with ggplot2

## 8.1 Creating a Publication-Quality Map

```{r ggplot-map}
# Load additional package for raster visualization in ggplot2
library(tidyterra)

# Create a comprehensive map
ggplot() +
  # Add raster layer (temperature)
  geom_spatraster(data = NoAm.WC.Bioclim.AEA[[1]] / 10) +
  
  # Add North America polygon
  geom_sf(data = NoAmPoly.AEA, fill = NA, color = "black") +
  
  # Add Bigfoot sightings
  geom_sf(data = Bigfoot.SpaPnt.AEA, color = "red", size = 2) +
  
  # Customize color scale
  scale_fill_whitebox_c(
    palette = "muted",
    labels = scales::label_number(suffix = "°C"),
    n.breaks = 12
  ) +
  
  # Add title and theme
  ggtitle(label = "Bigfoot Sightings and Annual Mean Temperature") +
  theme_minimal() +
  
  # Set coordinate limits
  coord_sf(xlim = range(st_coordinates(Bigfoot.SpaPnt.AEA)[, 1]),
           ylim = range(st_coordinates(Bigfoot.SpaPnt.AEA)[, 2])) +
  
  # Add axis labels
  labs(x = "Longitude", y = "Latitude")
```

**SOLUTION:** `geom_spatraster()` plots rasters, `geom_sf()` plots sf objects (with argument `data`), `ggtitle()` adds titles (with argument `label`), `theme_minimal()` sets theme, and `coord_sf()` sets coordinate system with `xlim` and `ylim` arguments.

---

# Summary

Congratulations! You've learned how to:

✓ Load spatial data from online sources  
✓ Work with sf (simple features) objects  
✓ Transform coordinate reference systems  
✓ Subset and filter spatial data  
✓ Combine point and polygon data  
✓ Work with raster data (loading, cropping, masking, transforming)  
✓ Extract raster values at point locations  
✓ Create professional spatial visualizations  

## Key Functions Reference

| Task | Function | Package |
|------|----------|---------|
| Read CSV | `read.csv()` | base R |
| Create sf object | `st_as_sf()` | sf |
| Transform CRS | `st_transform()` | sf |
| Extract geometry | `st_geometry()` | sf |
| Get coordinates | `st_coordinates()` | sf |
| Check CRS | `st_crs()` or `crs()` | sf/terra |
| Read raster | `rast()` | terra |
| Crop raster | `crop()` | terra |
| Mask raster | `mask()` | terra |
| Transform raster | `project()` | terra |
| Extract values | `extract()` | terra |
| Get country data | `ne_countries()` | rnaturalearth |

---

# Challenge Exercise - SOLUTIONS

## 1. Filter Bigfoot sightings to only those in the United States

```{r challenge-1}
# Method 1: Using spatial intersection
USA.poly <- NoAmPoly.AEA %>%
  filter(name_en == "United States of America")

Bigfoot.USA <- st_intersection(Bigfoot.SpaPnt.AEA, USA.poly)
head(Bigfoot.USA)

# Method 2: Using the state column in original data
Bigfoot.USA.alt <- Bigfoot.SpaPnt.AEA %>%
  filter(STATE_NAME %in% state.name)  # US state abbreviations
head(Bigfoot.USA.alt)
```

## 2. Extract elevation data for these sightings

```{r challenge-2}
# Assuming you have an elevation raster
 elevation <- rast("wc2.1_10m_elev.tif")
 elev_values <- terra::extract(elevation, Bigfoot.USA)
 Bigfoot.USA$elevation <- elev_values[,2]
```

## 3. Create a plot showing sightings colored by elevation

```{r challenge-3}
 #Using ggplot2
 ggplot() +
   geom_sf(data = USA.poly, fill = "lightgrey") +
   geom_sf(data = Bigfoot.USA, aes(color = elevation), size = 2) +
   scale_color_viridis_c(name = "Elevation (m)") +
   theme_minimal() +
   ggtitle("Bigfoot Sightings in USA by Elevation")
```

## 4. Calculate summary statistics of climate preferences

```{r challenge-4}
# Summary statistics for bioclimatic variables
summary_stats <- BFC %>%
  as_tibble() %>%
  summarise(across(where(is.numeric), 
                   list(mean = ~mean(., na.rm = TRUE),
                        sd = ~sd(., na.rm = TRUE),
                        min = ~min(., na.rm = TRUE),
                        max = ~max(., na.rm = TRUE))))

print(summary_stats)

# Temperature preferences (Bio1 is annual mean temperature)
temp_preference <- BFC %>%
  as_tibble() %>%
  select(wc2.1_10m_bio_1) %>%
  summarise(
    mean_temp = mean(wc2.1_10m_bio_1, na.rm = TRUE) / 10,  # Convert to °C
    min_temp = min(wc2.1_10m_bio_1, na.rm = TRUE) / 10,
    max_temp = max(wc2.1_10m_bio_1, na.rm = TRUE) / 10
  )

print(temp_preference)
```
